<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fragrance Forecast</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* ------------------- */
        /* Basic Setup & Reset */
        /* ------------------- */
        :root {
            --font-title: 'Playfair Display', serif;
            --font-body: 'Lato', sans-serif;
            --color-text: #333;
            --color-border: #e0d4ff;
            --color-box-bg: #e0e0e0;
        }

        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-body);
            background-color: #fdfdfd;
            color: var(--color-text);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
            border: 10px solid var(--color-border);
        }

        .hidden {
            display: none !important;
        }

        /* ------------------- */
        /* Main Container      */
        /* ------------------- */
        .container {
            width: 100%;
            max-width: 550px; /* Adjusted max-width */
            text-align: center;
            padding: 1rem;
        }

        /* ------------------- */
        /* Typography          */
        /* ------------------- */
        .title {
            font-family: var(--font-title);
            font-size: 3.5rem;
            font-weight: 700;
            color: #2c2c2c;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            font-family: var(--font-body);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #666;
            margin-bottom: 3rem;
        }

        /* ------------------- */
        /* Action Button       */
        /* ------------------- */
        .action-section {
            margin-bottom: 2rem;
        }

        .forecast-button {
            font-family: var(--font-body);
            font-size: 1rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #fff;
            background-color: #5a5a5a;
            border: none;
            padding: 1rem 2.5rem;
            border-radius: 50px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .forecast-button:hover {
            background-color: #333;
            transform: translateY(-2px);
        }

        .forecast-button:disabled {
            background-color: #999;
            cursor: not-allowed;
            transform: none;
        }
        
        /* ------------------- */
        /* Info & Results Boxes*/
        /* ------------------- */
        .info-box {
            background-color: var(--color-box-bg);
            padding: 1.5rem 2rem;
            text-align: left;
            background-image: url('data:image/svg+xml;charset=utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><filter id="f"><feTurbulence type="fractalNoise" baseFrequency="0.03" numOctaves="3" seed="1"/></filter><rect width="100%" height="100%" filter="url(%23f)" opacity="0.1"/></svg>');
            border-radius: 4px;
            margin-top: 1.5rem;
        }

        .info-box h2 {
            font-family: var(--font-title);
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: #444;
        }

        .info-box p {
            font-family: var(--font-body);
            font-size: 1rem;
            line-height: 1.6;
        }
        
        #fragrance-recommendation {
            font-weight: 700;
            color: #000;
        }

        /* ------------------- */
        /* Loading & Error     */
        /* ------------------- */
        .loading-section {
            padding: 2rem;
            font-size: 1.1rem;
            color: #666;
        }
        
        .error-box {
            background-color: #fbe2e2;
            color: #8b1818;
            border: 1px solid #f5caca;
            padding: 1.5rem;
            border-radius: 4px;
            margin-top: 1.5rem;
        }

        /* ------------------- */
        /* Responsive Design   */
        /* ------------------- */
        @media (max-width: 768px) {
            body {
                padding: 1rem;
                border-width: 5px;
            }
            .title {
                font-size: 2.5rem;
            }
            .subtitle {
                margin-bottom: 2rem;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1 class="title">Fragrance Forecast</h1>
            <p class="subtitle">Get your suggested scent based on the weather</p>
        </header>

        <main>
            <!-- Button to trigger the forecast -->
            <div class="action-section">
                <button id="getForecastBtn" class="forecast-button">Get My Scent</button>
            </div>

            <!-- Loading State -->
            <div id="loading" class="loading-section hidden">
                <p id="loading-message">Getting your forecast...</p>
            </div>

            <!-- Error State -->
            <div id="error-box" class="error-box hidden">
                <p id="error-message"></p>
            </div>

            <!-- Results Display -->
            <div id="results" class="results-section hidden">
                <div class="info-box">
                    <h2 id="location-display">Forecast for your location</h2>
                    <p id="weather-display">Weather details...</p>
                </div>
                <div class="info-box">
                    <h2>Suggested Scent Profile</h2>
                    <p id="fragrance-recommendation">Scent notes...</p>
                    <p id="fragrance-reason">Mood and reason...</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- DOM Elements ---
        const getForecastBtn = document.getElementById('getForecastBtn');
        const resultsDiv = document.getElementById('results');
        const loadingDiv = document.getElementById('loading');
        const loadingMessage = document.getElementById('loading-message');
        const errorBox = document.getElementById('error-box');
        const errorMessage = document.getElementById('error-message');

        // --- UI Update Functions ---
        const locationDisplay = document.getElementById('location-display');
        const weatherDisplay = document.getElementById('weather-display');
        const fragranceRecommendation = document.getElementById('fragrance-recommendation');
        const fragranceReason = document.getElementById('fragrance-reason');

        /**
         * Shows a loading message.
         * @param {string} message - The message to display.
         */
        function showLoading(message) {
            loadingMessage.textContent = message;
            loadingDiv.classList.remove('hidden');
            resultsDiv.classList.add('hidden');
            errorBox.classList.add('hidden');
            getForecastBtn.disabled = true;
        }

        /**
         * Hides the loading message and enables the button.
         */
        function hideLoading() {
            loadingDiv.classList.add('hidden');
            getForecastBtn.disabled = false;
        }

        /**
         * Displays an error message.
         * @param {string} message - The error message to show.
         */
        function showError(message) {
            errorMessage.textContent = message;
            errorBox.classList.remove('hidden');
            resultsDiv.classList.add('hidden'); // Hide results on error
            hideLoading();
        }

        /**
         * Updates the UI with the final forecast and fragrance data.
         * @param {object} data - The combined weather and fragrance data.
         */
        function updateUI(data) {
            locationDisplay.textContent = `Forecast for ${data.city}`;
            weatherDisplay.textContent = `${data.weather.description}, ${data.weather.temperature}°C`;
            fragranceRecommendation.textContent = data.fragrance.scents;
            fragranceReason.textContent = `Mood: ${data.fragrance.mood}. ${data.fragrance.reason}`;
            resultsDiv.classList.remove('hidden');
        }


        // --- API Logic ---

        /**
         * Fetches weather data from the Open-Meteo API.
         * @param {number} latitude - The latitude.
         * @param {number} longitude - The longitude.
         * @returns {Promise<object>} - A promise that resolves to the weather data.
         */
        async function getWeatherData(latitude, longitude) {
            const weatherApiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true`;
            const response = await fetch(weatherApiUrl);
            if (!response.ok) {
                throw new Error('Could not fetch weather data.');
            }
            const data = await response.json();
            return {
                temperature: Math.round(data.current_weather.temperature),
                description: getWeatherDescription(data.current_weather.weathercode),
            };
        }

        /**
         * Fetches the city name from latitude and longitude using a reverse geocoding API.
         * @param {number} latitude
         * @param {number} longitude
         * @returns {Promise<string>}
         */
        async function getCityName(latitude, longitude) {
            // Using a free, no-key-required reverse geocoding service
            const geoApiUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`;
            const response = await fetch(geoApiUrl);
            if (!response.ok) {
                return "your location"; // Fallback
            }
            const data = await response.json();
            return data.address.city || data.address.town || "your location";
        }


        /**
         * Calls the Gemini API to get a fragrance recommendation.
         * @param {object} weatherData - The current weather data.
         * @returns {Promise<object>} - A promise that resolves to the fragrance recommendation.
         */
        async function getFragranceFromAI(weatherData) {
            const apiKey = "AIzaSyBCdr_tHM21VxRsyzShGAmBL0amaA6HKzk"; // Leave empty, will be handled by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const prompt = `
                Based on the following weather conditions, recommend a fragrance profile.
                Weather: ${weatherData.description}
                Temperature: ${weatherData.temperature}°C

                Provide your response in a JSON object with the following structure:
                {
                  "mood": "A short description of the mood or feeling",
                  "atmosphere": "A description of the overall atmosphere",
                  "scents": "Key scent notes, e.g., 'Citrus & Bergamot'",
                  "reason": "A brief explanation for the recommendation."
                }
            `;

            const payload = {
                contents: [{
                    parts: [{
                        text: prompt
                    }]
                }],
                generationConfig: {
                    responseMimeType: "application/json",
                }
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`AI API request failed with status ${response.status}`);
            }

            const result = await response.json();
            if (result.candidates && result.candidates.length > 0) {
                const jsonText = result.candidates[0].content.parts[0].text;
                return JSON.parse(jsonText);
            } else {
                throw new Error('Invalid response structure from AI API.');
            }
        }


        // --- Main Application Flow ---

        getForecastBtn.addEventListener('click', async () => {
            if (!navigator.geolocation) {
                showError("Geolocation is not supported by your browser.");
                return;
            }

            showLoading("Getting your location...");

            navigator.geolocation.getCurrentPosition(async (position) => {
                try {
                    const {
                        latitude,
                        longitude
                    } = position.coords;

                    showLoading("Fetching weather data...");
                    const [weather, city] = await Promise.all([
                        getWeatherData(latitude, longitude),
                        getCityName(latitude, longitude)
                    ]);


                    showLoading("Creating your fragrance profile...");
                    const fragrance = await getFragranceFromAI(weather);

                    hideLoading();
                    updateUI({
                        weather,
                        fragrance,
                        city
                    });

                } catch (error) {
                    console.error("Error:", error);
                    showError(error.message || "An unknown error occurred.");
                }
            }, (error) => {
                // Geolocation error handling
                let message = "Could not get your location. Please allow location access.";
                if (error.code === error.PERMISSION_DENIED) {
                    message = "Location access was denied. Please enable it in your browser settings.";
                }
                showError(message);
            });
        });


        // --- Helper Functions ---

        /**
         * Converts WMO weather codes to human-readable descriptions.
         * @param {number} code - The WMO weather code.
         * @returns {string} - The weather description.
         */
        function getWeatherDescription(code) {
            const descriptions = {
                0: "Clear sky", 1: "Mainly clear", 2: "Partly cloudy", 3: "Overcast",
                45: "Fog", 48: "Depositing rime fog", 51: "Light drizzle", 53: "Moderate drizzle",
                55: "Dense drizzle", 56: "Light freezing drizzle", 57: "Dense freezing drizzle",
                61: "Slight rain", 63: "Moderate rain", 65: "Heavy rain",
                66: "Light freezing rain", 67: "Heavy freezing rain", 71: "Slight snow fall",
                73: "Moderate snow fall", 75: "Heavy snow fall", 77: "Snow grains",
                80: "Slight rain showers", 81: "Moderate rain showers", 82: "Violent rain showers",
                85: "Slight snow showers", 86: "Heavy snow showers", 95: "Thunderstorm",
                96: "Thunderstorm with slight hail", 99: "Thunderstorm with heavy hail",
            };
            return descriptions[code] || "Unknown weather";
        }
    </script>
</body>
</html>
